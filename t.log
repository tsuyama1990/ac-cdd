============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0 -- /home/tomo/project/ac-cdd/.venv/bin/python3
cachedir: .pytest_cache
hypothesis profile 'default'
rootdir: /home/tomo/project/ac-cdd
configfile: pyproject.toml
plugins: hypothesis-6.148.7, logfire-4.16.0, langsmith-0.4.59, asyncio-1.3.0, cov-7.0.0, anyio-4.12.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/ac_cdd/integration/test_end_to_end_workflow.py::TestEndToEndWorkflow::test_session_persistence_across_commands Running Pending Cycles: ['01']
Starting Cycle 01 (1/1)
────────────────────────────────────────────────────────────────────────────────────────────────────────────── Coder Phase: Cycle 01 ───────────────────────────────────────────────────────────────────────────────────────────────────────────────
✅ Cycle 01 Implementation Request Sent!

Jules has created a Pull Request with the implementation.

Next Steps:
1. Review the Pull Request on GitHub.
2. Merge the PR if the implementation and tests pass.
3. Pull the changes locally:
   git checkout main && git pull
4. Proceed to the next cycle:
   uv run manage.py run-cycle --id 02
Completed Cycle 01 (1/1)
────────────────────────────────────────────────────────────────────────────────────────────────────────── QA Phase: Tutorial Generation ───────────────────────────────────────────────────────────────────────────────────────────────────────────
Running QA Tutorial Generation Graph...
Tutorial Generation Failed: object MagicMock can't be used in 'await' expression
────────────────────────────────────────────────────────────────────────────────────────────────────────── Finalizing Development Session ──────────────────────────────────────────────────────────────────────────────────────────────────────────
✅ Final PR Created!

PR URL: http://pr

Next Steps:
1. Review the PR on GitHub
2. Merge to main when ready
3. The integration branch will be automatically deleted

To start a new session, run: uv run manage.py gen-cycles

Archiving session artifacts to /home/tomo/project/ac-cdd/dev_documents/phase_4...
Finalization failed: [Errno 2] No such file or directory: "<MagicMock name='StateManager().STATE_FILE' id='140442950746032'>"
FAILED

=================================== FAILURES ===================================
________ TestEndToEndWorkflow.test_session_persistence_across_commands _________

self = <ac_cdd_core.services.workflow.WorkflowService object at 0x7fbb6c467320>
project_session_id = None

    async def finalize_session(self, project_session_id: str | None) -> None:
        console.rule("[bold cyan]Finalizing Development Session[/bold cyan]")
        ensure_api_key()
    
        mgr = StateManager()
        manifest = mgr.load_manifest()
    
        sid = project_session_id or (manifest.project_session_id if manifest else None)
        integration_branch = manifest.integration_branch if manifest else None
    
        if not sid or not integration_branch:
            console.print("[red]No active session found to finalize.[/red]")
            sys.exit(1)
    
        git = GitManager()
        try:
            pr_url = await git.create_final_pr(
                integration_branch=integration_branch,
                title=f"Finalize Development Session: {sid}",
                body=f"This PR merges all implemented cycles from session {sid} into main.",
            )
            console.print(SuccessMessages.session_finalized(pr_url))
    
            # Archive and reset for next phase
            # Archive and reset for next phase
>           await self._archive_and_reset_state()

dev_src/ac_cdd_core/services/workflow.py:370: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
dev_src/ac_cdd_core/services/workflow.py:454: in _archive_and_reset_state
    shutil.copy2(str(state_mgr.STATE_FILE), str(phase_dir / "project_state.json"))
/usr/lib/python3.12/shutil.py:475: in copy2
    copyfile(src, dst, follow_symlinks=follow_symlinks)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

src = "<MagicMock name='StateManager().STATE_FILE' id='140442950746032'>"
dst = '/home/tomo/project/ac-cdd/dev_documents/phase_4/project_state.json'

    def copyfile(src, dst, *, follow_symlinks=True):
        """Copy data from src to dst in the most efficient way possible.
    
        If follow_symlinks is not set and src is a symbolic link, a new
        symlink will be created instead of copying the file it points to.
    
        """
        sys.audit("shutil.copyfile", src, dst)
    
        if _samefile(src, dst):
            raise SameFileError("{!r} and {!r} are the same file".format(src, dst))
    
        file_size = 0
        for i, fn in enumerate([src, dst]):
            try:
                st = _stat(fn)
            except OSError:
                # File most likely does not exist
                pass
            else:
                # XXX What about other special files? (sockets, devices...)
                if stat.S_ISFIFO(st.st_mode):
                    fn = fn.path if isinstance(fn, os.DirEntry) else fn
                    raise SpecialFileError("`%s` is a named pipe" % fn)
                if _WINDOWS and i == 0:
                    file_size = st.st_size
    
        if not follow_symlinks and _islink(src):
            os.symlink(os.readlink(src), dst)
        else:
>           with open(src, 'rb') as fsrc:
                 ^^^^^^^^^^^^^^^
E           FileNotFoundError: [Errno 2] No such file or directory: "<MagicMock name='StateManager().STATE_FILE' id='140442950746032'>"

/usr/lib/python3.12/shutil.py:260: FileNotFoundError

During handling of the above exception, another exception occurred:

self = <integration.test_end_to_end_workflow.TestEndToEndWorkflow object at 0x7fbb6c464f20>
mock_sm_cls = <MagicMock name='StateManager' id='140442950329040'>
workflow = <ac_cdd_core.services.workflow.WorkflowService object at 0x7fbb6c467320>

    @patch("ac_cdd_core.services.workflow.StateManager")
    async def test_session_persistence_across_commands(
        self, mock_sm_cls: MagicMock, workflow: WorkflowService
    ) -> None:
        # This test previously verified file persistence. Now we verify interaction with Git-backed SessionManager.
        mock_mgr = mock_sm_cls.return_value
    
        with patch("ac_cdd_core.services.workflow.GitManager") as mock_git_cls:
            mock_git_cls.return_value.create_final_pr = AsyncMock(return_value="http://pr")
            mock_git_cls.return_value.checkout_branch = AsyncMock()
            mock_git_cls.return_value.pull_changes = AsyncMock()
    
            # Simulate loading manifest
            manifest = ProjectManifest(
                project_session_id="p1",
                feature_branch="feat/p1",
                integration_branch="dev/p1",
                cycles=[{"id": "01", "status": "planned"}]
            )
            mock_mgr.load_manifest = MagicMock(return_value=manifest)
    
            # Setup Cleanup
            workflow.builder.cleanup = AsyncMock()
    
            # Setup build_coder_graph
            mock_graph = AsyncMock()
            mock_graph.ainvoke.return_value = {"status": "completed"}
            workflow.builder.build_coder_graph.return_value = mock_graph
    
>           await workflow._run_all_cycles(
                resume=False, auto=True, start_iter=1, project_session_id=None
            )

tests/ac_cdd/integration/test_end_to_end_workflow.py:117: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
dev_src/ac_cdd_core/services/workflow.py:141: in _run_all_cycles
    await self.finalize_session(project_session_id)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <ac_cdd_core.services.workflow.WorkflowService object at 0x7fbb6c467320>
project_session_id = None

    async def finalize_session(self, project_session_id: str | None) -> None:
        console.rule("[bold cyan]Finalizing Development Session[/bold cyan]")
        ensure_api_key()
    
        mgr = StateManager()
        manifest = mgr.load_manifest()
    
        sid = project_session_id or (manifest.project_session_id if manifest else None)
        integration_branch = manifest.integration_branch if manifest else None
    
        if not sid or not integration_branch:
            console.print("[red]No active session found to finalize.[/red]")
            sys.exit(1)
    
        git = GitManager()
        try:
            pr_url = await git.create_final_pr(
                integration_branch=integration_branch,
                title=f"Finalize Development Session: {sid}",
                body=f"This PR merges all implemented cycles from session {sid} into main.",
            )
            console.print(SuccessMessages.session_finalized(pr_url))
    
            # Archive and reset for next phase
            # Archive and reset for next phase
            await self._archive_and_reset_state()
    
        except Exception as e:
            console.print(f"[bold red]Finalization failed:[/bold red] {e}")
>           sys.exit(1)
E           SystemExit: 1

dev_src/ac_cdd_core/services/workflow.py:374: SystemExit
------------------------------ Captured log call -------------------------------
ERROR    AC-CDD:workflow.py:343 Tutorial Generation Failed
Traceback (most recent call last):
  File "/home/tomo/project/ac-cdd/dev_src/ac_cdd_core/services/workflow.py", line 322, in generate_tutorials
    final_state = await graph.ainvoke(initial_state, config)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
  /home/tomo/project/ac-cdd/.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Name                                                               Stmts   Miss  Cover   Missing
------------------------------------------------------------------------------------------------
dev_src/__init__.py                                                    0      0   100%
dev_src/ac_cdd_core/__init__.py                                        0      0   100%
dev_src/ac_cdd_core/agents.py                                         74     57    23%   16-19, 24-44, 49-72, 80-96, 110-122, 128-149
dev_src/ac_cdd_core/cli.py                                           153    153     0%   1-348
dev_src/ac_cdd_core/config.py                                        182     49    73%   18-27, 41, 49, 215, 221, 225-233, 237-247, 250-263, 266-285
dev_src/ac_cdd_core/contracts/__init__.py                              0      0   100%
dev_src/ac_cdd_core/domain_models.py                                  93      0   100%
dev_src/ac_cdd_core/error_messages.py                                  7      7     0%   4-18
dev_src/ac_cdd_core/graph.py                                          50     31    38%   20-26, 30-31, 35-42, 46-92, 95, 98, 102-127, 130
dev_src/ac_cdd_core/graph_nodes.py                                   541    506     6%   30-36, 40-50, 54-111, 115-186, 195-251, 255-468, 472-746, 755-846, 854-890, 893-903, 907, 911-920, 924-929, 933-1058, 1062-1130, 1137-1142
dev_src/ac_cdd_core/hash_utils.py                                     25     22    12%   7-30
dev_src/ac_cdd_core/interfaces.py                                      5      0   100%
dev_src/ac_cdd_core/jules_session_graph.py                            45     45     0%   3-110
dev_src/ac_cdd_core/jules_session_nodes.py                           279    279     0%   3-505
dev_src/ac_cdd_core/jules_session_state.py                            44     44     0%   3-75
dev_src/ac_cdd_core/messages.py                                       56     18    68%   16-17, 29, 40-41, 46, 51-52, 66, 75, 95-96, 126, 150-151, 159-161
dev_src/ac_cdd_core/process_runner.py                                 39     33    15%   23-74
dev_src/ac_cdd_core/sandbox.py                                        97     81    16%   18-25, 29-58, 66-119, 123, 127, 134-154, 158, 161-163
dev_src/ac_cdd_core/service_container.py                              18      1    94%   22
dev_src/ac_cdd_core/services/__init__.py                               5      0   100%
dev_src/ac_cdd_core/services/artifacts.py                             14      8    43%   17-28
dev_src/ac_cdd_core/services/audit_orchestrator.py                    72     60    17%   27-29, 37-120, 126-142
dev_src/ac_cdd_core/services/contracts.py                             26     21    19%   16-43
dev_src/ac_cdd_core/services/file_ops.py                             110     89    19%   28-59, 62-80, 88-103, 112-123, 126-137, 140-145, 149-171
dev_src/ac_cdd_core/services/git/base.py                              28     16    43%   18-25, 29-36, 40-43
dev_src/ac_cdd_core/services/git/branching.py                         88     77    12%   10-13, 17, 23-38, 43-50, 56-77, 81-108, 114-131, 135-165
dev_src/ac_cdd_core/services/git/checkout.py                          95     79    17%   14-30, 35-50, 54-63, 70-83, 87-91, 95, 99-104, 108-110, 114-119, 123, 127-145
dev_src/ac_cdd_core/services/git/merging.py                           80     70    12%   16-31, 35-50, 57-114, 118-174
dev_src/ac_cdd_core/services/git/state.py                             56     45    20%   21-68, 74-80, 84-111
dev_src/ac_cdd_core/services/git_ops.py                                9      0   100%
dev_src/ac_cdd_core/services/jules/api.py                            117     94    20%   21-32, 38-51, 54-64, 69-91, 94-103, 106-107, 110-114, 125-136, 140-142, 145-167
dev_src/ac_cdd_core/services/jules/context_builder.py                 79     67    15%   11, 20-32, 36-44, 48-76, 80-88, 97-134
dev_src/ac_cdd_core/services/jules/git_context.py                     42     32    24%   14, 17-56, 59-60
dev_src/ac_cdd_core/services/jules/inquiry_handler.py                149    131    12%   19-21, 27-57, 60-73, 79-102, 106-139, 150-185, 198-247
dev_src/ac_cdd_core/services/jules_client.py                         387    337    13%   9-10, 53-84, 92, 96, 100-106, 110-115, 126-166, 170-189, 193-205, 219-289, 295-358, 361-363, 375-385, 393-444, 450-497, 500-514, 519-529, 532-543, 547, 551-573, 577-584, 590-602, 606-609, 617-687
dev_src/ac_cdd_core/services/llm_reviewer.py                          26     20    23%   14-18, 39-68, 78-90
dev_src/ac_cdd_core/services/plan_auditor.py                          26     17    35%   12-18, 27, 53-117
dev_src/ac_cdd_core/services/project.py                               46     35    24%   22-45, 49-58, 64-81
dev_src/ac_cdd_core/services/project_setup/dependency_manager.py      50     42    16%   12-13, 16-56, 60-77
dev_src/ac_cdd_core/services/project_setup/permission_manager.py      62     56    10%   13-74
dev_src/ac_cdd_core/services/project_setup/template_manager.py        84     72    14%   12-30, 33-35, 41-62, 65-97, 100-167, 170-190, 193-239
dev_src/ac_cdd_core/services/sandbox/sync.py                          31     21    32%   15-16, 25-48
dev_src/ac_cdd_core/services/workflow.py                             249    108    57%   32-94, 104-112, 123, 157-158, 179-180, 193-197, 216-217, 225-228, 233-279, 291-294, 297-300, 324-339, 356-357, 385, 409-415, 433-443, 449, 455-472
dev_src/ac_cdd_core/session_manager.py                                65     48    26%   25, 29-38, 44-50, 56-64, 68-75, 83-107
dev_src/ac_cdd_core/state.py                                          65     10    85%   82-85, 90-93, 96, 99
dev_src/ac_cdd_core/state_manager.py                                  90     72    20%   25-37, 46-57, 69-86, 102-108, 112-115, 127-135, 151-176, 188-206
dev_src/ac_cdd_core/tools.py                                          21     21     0%   1-48
dev_src/ac_cdd_core/utils.py                                          72     28    61%   31-56, 72-77, 88, 94-96, 100, 119-120, 140-141, 155-159
dev_src/ac_cdd_core/validators.py                                     41     41     0%   3-86
------------------------------------------------------------------------------------------------
TOTAL                                                               3993   3043    24%
=========================== short test summary info ============================
FAILED tests/ac_cdd/integration/test_end_to_end_workflow.py::TestEndToEndWorkflow::test_session_persistence_across_commands - SystemExit: 1
========================= 1 failed, 1 warning in 2.74s =========================
